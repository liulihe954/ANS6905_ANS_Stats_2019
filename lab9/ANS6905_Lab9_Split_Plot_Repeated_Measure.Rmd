---
title: "ANS6905_Lab9_Repeated_Mesure"
author: "Lihe Liu"
date: "11/21/2019"
output: html_document
---
```{r,include=F}
library(tidyverse)
library(lme4)
library(lmerTest)
library(nlme)
library(gridExtra)
library(faraway)
library(pbkrtest)
library(car)
library(glmmTMB)
library(gdata)
library(openxlsx)
```

```{r}
rep.data.raw <- read.xls("ANS6905_Lab09_new_rm.xlsx",header=T)
names(rep.data.raw)
str(rep.data.raw)
# massage
rep.data = rep.data.raw %>%
  #dplyr::mutate(ID = as.character(ID)) %>% 
  dplyr::mutate_at(c("TRT","Day","ID","Litter"),factor) %>%
  dplyr::mutate_at(c("TRT"),funs(dplyr::recode(.,`0`= "A", `2`= "B",`4`= "C"))) %>% 
  dplyr::mutate_at(c("Litter"),funs(dplyr::recode(.,`1`= "L1", `2`= "L2",`3`= "L3",`4`= "L4",`5`= "L5"))) %>% 
  dplyr::select(-X,-BWCov)
str(rep.data)
summary(rep.data)
```

Use ?corClasses() to check all the standard classes of correlation structures (corStruct) available in the nlme package. 
```{r}
#?corClasses()
```

| function    | Description |
| ----------- | ----------- |
| corAR1      | autoregressive process of order 1|
| corARMA	    | autoregressive moving average process, with arbitrary orders for the autoregressive and moving average components|
| corCAR1	    | continuous autoregressive process (AR(1) process for a continuous time covariate)|
| corCompSymm	| compound symmetry structure corresponding to a constant correlation|
| corExp      | exponential spatial correlation|
| corGaus	    | Gaussian spatial correlation|
| corLin      | linear spatial correlation|
| corRatio    | Rational quadratics spatial correlation|
| corSpher    | spherical spatial correlation|
| corSymm	    | general correlation matrix, with no additional structure|
	
```{r}
######## Unstructured Symmetry #######
fit.us = lme(BW ~ TRT * Day, data = rep.data,
             random = ~1|Litter/TRT,
             correlation = corSymm(form= ~1|Litter/TRT),
             weight=varIdent(form=~1|Day))
anova(fit.us)
# AIC(fit.us)
# summary(fit.us)
```


```{r}
######## Compound Symmetry ############
fit.cs <- lme(BW ~ TRT * Day, data = rep.data,
              random = ~1|Litter/TRT,
              correlation = corCompSymm(form= ~1|Litter/TRT),
              weights = varIdent(form = ~ 1|Day))

anova(fit.cs)
# AIC(fit.cs)
# summary(fit.cs)
```


```{r}
######## Auto Regressive ###############
fit.ar <- lme(BW ~ TRT * Day, data = rep.data,
              random = ~1|Litter/TRT,
              correlation = corAR1(form= ~1|Litter/TRT),
              weights = varIdent(form = ~ 1|Day))
anova(fit.ar)
# AIC(fit.ar)
# summary(fit.ar)
```


```{r}
#########    VCOV: Toeplitz   ################
fit.toep <- glmmTMB(BW ~ TRT + Day + TRT:Day + (1|Litter/TRT), 
                    data = rep.data, dispformula=~0)
# summary(fit.toep)
# VarCorr(fit.toep)
```


```{r}
########    VCOV: spatial power ##################
fit.sp <- lme(BW ~ TRT * Day, data = rep.data,
              random = ~1|Litter/TRT,
              correlation = corExp(form= ~1|Litter/TRT),
              weights = varIdent(form = ~ 1|Day))
anova(fit.sp)
# AIC(fit.sp)
# summary(fit.sp)
```

Compare model
```{r}
anova(fit.cs,fit.us,fit.ar,fit.sp)
```

